{% extends 'common/base.html' %}

{% block content %}
    <a href="{% url 'create-book' %}">Add Book</a>
    <a href="{% url 'author-create' %}">Add Author</a>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-7"> <!-- Adjust the column width to make it smaller -->
                {% for book in books %}
                    <div class="mb-4">
                        <div class="row justify-content-center">
                            <div class="col-md-2 col-lg-2 col-sm-3 col-xs-2">
                                <!-- Book Cover Image -->
                                <a href="{% url 'book-details' book.pk %}">
                                    <img src="{{ book.cover.url }}"
                                         alt="{{ book.title }}" class="img-fluid rounded">
                                </a>
                            </div>
                            <div class="col-md-10">
                                <div class="card-body">

                                    <!-- Book Title -->
                                    <div class="d-flex align-items-center">
                                        <a href="{% url 'book-details' book.pk %}" class="text-decoration-none">
                                            <h5 class="card-title"> {{ book.title }} </h5>
                                        </a>
                                        <a href="" class="text-decoration-none ms-2">
                                            <h5>(Mistborn, #1)</h5>
                                        </a>
                                    </div>

                                    <!-- Author -->
                                    <p class="card-text">
                                        <small class="text-muted">by Brandon Sanderson</small>
                                    </p>
                                    <p class="card-text">
                                        <span class="text-warning">
                                            {% with average_rating=book.average_rating %}
                                                {% for i in "12345" %}
                                                    {% if average_rating >= forloop.counter %}
                                                        <i class="fas fa-star"></i> <!-- Full star icon -->
                                                    {% elif average_rating >= forloop.counter0|add:0.5 %}
                                                        <i class="fas fa-star-half-alt"></i> <!-- Half star icon -->
                                                    {% else %}
                                                        <i class="far fa-star"></i> <!-- Empty star icon -->
                                                    {% endif %}
                                                {% endfor %}
                                            {% endwith %}
                                            <small class="text-muted">{{ book.average_rating|default:"No ratings yet" }} — </small>
                                        </span>
                                        {% if book.rating_count != 1 %}
                                            <small class="text-muted">{{ book.rating_count }} ratings —
                                                published {{ book.publication_date }}</small>
                                        {% else %}
                                            <small class="text-muted">{{ book.rating_count }} rating —
                                                published {{ book.publication_date }}</small>
                                        {% endif %}
                                    </p>
                                    <div class="d-flex align-items-center mb-0">
                                        <div class="dropdown">
                                            <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="readingListDropdown-{{ book.pk }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                {% if book.pk in want_to_read_books %}
                                                    Want to Read
                                                {% elif book.pk in currently_reading_books %}
                                                    Currently Reading
                                                {% elif book.pk in read_books %}
                                                    Read
                                                {% elif book.pk in favorites_books %}
                                                    Favorites
                                                {% else %}
                                                    Add to List
                                                {% endif %}
                                            </button>

                                            <ul class="dropdown-menu" aria-labelledby="readingListDropdown-{{ book.pk }}">
                                                <li><a class="dropdown-item add-to-list" href="#" data-book-id="{{ book.pk }}" data-list-type="want_to_read">Want to Read</a></li>
                                                <li><a class="dropdown-item add-to-list" href="#" data-book-id="{{ book.pk }}" data-list-type="currently_reading">Currently Reading</a></li>
                                                <li><a class="dropdown-item add-to-list" href="#" data-book-id="{{ book.pk }}" data-list-type="read">Read</a></li>
                                                <li><a class="dropdown-item add-to-list" href="#" data-book-id="{{ book.pk }}" data-list-type="favorites">Favorites</a></li>
                                                <li><a class="dropdown-item remove-from-list" href="#" data-book-id="{{ book.pk }}">Remove from List</a></li>
                                            </ul>
                                        </div>
                                        {% if book.user_rating %}
                                            <small class="text-muted">My rating:</small>
                                        {% else %}
                                            <small class="text-muted">Rate:</small>
                                        {% endif %}
                                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                        <!-- Krajee Star Rating -->
                                        <input id="input-{{ book.pk }}" name="rating" type="number" class="rating"
                                               data-size="xs" data-book-id="{{ book.pk }}"
                                               data-show-clear="true" data-show-caption="true" data-theme="krajee-fas"
                                               data-url="{% url 'rate-book' book.pk %}"
                                                {% if book.user_rating %}
                                               value="{{ book.user_rating }}"
                                                {% endif %}
                                        >
                                    </div>
                                    <!-- User Rating -->
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // Initialize star rating for all rating inputs
            $(".rating").each(function () {
                var $ratingInput = $(this);
                var ratingUrl = $ratingInput.data('url');  // Get the URL to submit the rating
                var ratingValue = $ratingInput.val();  // Get the initial rating value for display

                // Initialize the Krajee star rating plugin
                $ratingInput.rating({
                    theme: 'krajee-fas',
                    filledStar: '<i class="fas fa-star"></i>',
                    emptyStar: '<i class="far fa-star"></i>',
                    showCaption: false,  // Hide caption below stars
                    showClear: true,  // Enable clear button
                    step: 0.5,  // Allow half-star ratings
                    value: ratingValue  // Set initial value
                }).on('rating:change', function (event, value) {
                    // Fetch CSRF token for secure requests
                    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

                    // Make AJAX POST request to save the rating
                    $.ajax({
                        url: ratingUrl,
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken
                        },
                        data: {
                            rating: value
                        },
                        success: function (response) {
                            if (!response.success) {
                                console.error('Failed to submit rating: ' + response.message);
                            }
                        },
                        error: function () {
                            console.error('Failed to submit rating');
                        }
                    });
                }).on('rating:clear', function (event) {
                    // Handle clearing the rating
                    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

                    $.ajax({
                        url: ratingUrl,
                        method: 'DELETE',  // Changed method to DELETE to represent removing the rating
                        headers: {
                            'X-CSRFToken': csrfToken
                        },
                        success: function (response) {
                            if (!response.success) {
                                console.error('Failed to clear rating: ' + response.message);
                            }
                        },
                        error: function () {
                            console.error('Failed to clear rating');
                        }
                    });
                });
            });
        });
    </script>
{#    <script>#}
{#        function addToList(bookId, listType) {#}
{#            const csrfToken = '{{ csrf_token }}';#}
{#            $.ajax({#}
{#                url: '{% url "add-to-reading-list" %}',  // Update this to point to the view handling the action#}
{#                method: 'POST',#}
{#                headers: {#}
{#                    'X-CSRFToken': csrfToken#}
{#                },#}
{#                data: {#}
{#                    book_id: bookId,#}
{#                    list_type: listType#}
{#                },#}
{#                success: function(response) {#}
{#                    if (response.success) {#}
{#                        alert('Book added successfully to ' + listType.replace('_', ' ') + '!');#}
{#                    } else {#}
{#                        alert('Failed to add book: ' + response.message);#}
{#                    }#}
{#                },#}
{#                error: function(xhr, status, error) {#}
{#                    alert('Failed to add book to the list');#}
{#                }#}
{#            });#}
{#        }#}
{#    </script>#}
    <script>
        $(document).ready(function () {
            // Add book to a specific reading list
            $('.add-to-list').click(function (e) {
                e.preventDefault();
        
                var bookId = $(this).data('book-id');
                var listType = $(this).data('list-type');
                var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
        
                $.ajax({
                    url: '{% url "add-to-reading-list" %}',
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    data: {
                        book_id: bookId,
                        list_type: listType
                    },
                    success: function (response) {
                        if (response.success) {
                            // Update button text to reflect the current selection
                            var dropdownButton = $('#readingListDropdown-' + bookId);
                            switch (listType) {
                                case 'want_to_read':
                                    dropdownButton.text('Want to Read');
                                    break;
                                case 'currently_reading':
                                    dropdownButton.text('Currently Reading');
                                    break;
                                case 'read':
                                    dropdownButton.text('Read');
                                    break;
                                case 'favorites':
                                    dropdownButton.text('Favorites');
                                    break;
                            }
                        } else {
                            console.error('Failed to add to list: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Failed to add to reading list');
                    }
                });
            });
        
            // Remove book from reading list
            $('.remove-from-list').click(function (e) {
                e.preventDefault();
        
                var bookId = $(this).data('book-id');
                var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
        
                $.ajax({
                    url: '{% url "remove-from-reading-list" %}',
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    data: {
                        book_id: bookId
                    },
                    success: function (response) {
                        if (response.success) {
                            // Update button text to reflect no list selection
                            var dropdownButton = $('#readingListDropdown-' + bookId);
                            dropdownButton.text('Add to List');
                        } else {
                            console.error('Failed to remove from list: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Failed to remove from reading list');
                    }
                });
            });
        });
    </script>
{% endblock %}
